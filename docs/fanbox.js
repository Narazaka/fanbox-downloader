(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{main:()=>l});let n={posts:{},postCount:0,fileCount:0,id:"undefined"},o=0,r=!1;const i=(e,t,n)=>`${t} ${n+1}.${e.extension}`,s=(e,t,n)=>`${t} ${e.name}.${e.extension}`,a=new class{constructor(){this.bootCSS={href:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css",integrity:"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"},this.bootJS={src:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js",integrity:"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"}}async createDownloadUI(e){document.head.innerHTML="",document.body.innerHTML="",document.getElementsByTagName("html")[0].style.height="100%",document.body.style.height="100%",document.body.style.margin="0",document.title=e;let t=document.createElement("link");t.href=this.bootCSS.href,t.rel="stylesheet",t.integrity=this.bootCSS.integrity,t.crossOrigin="anonymous",document.head.appendChild(t);let n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.flexDirection="column",n.style.height="100%";let o=document.createElement("div");o.className="input-group mb-2",o.style.width="400px";let r=document.createElement("input");r.type="text",r.className="form-control",r.placeholder="ここにJSONを貼り付け",o.appendChild(r);let i=document.createElement("div");i.className="input-group-append";let s=document.createElement("button");s.className="btn btn-outline-secondary btn-labeled",s.type="button",s.innerText="Download",i.appendChild(s),o.appendChild(i),n.appendChild(o);let a=document.createElement("div");a.className="progress mb-3",a.style.width="400px";let l=document.createElement("div");l.className="progress-bar",l.role="progressbar",l["aria-valuemin"]="0",l["aria-valuemax"]="100",l["aria-valuenow"]="0",l.style.width="0%",l.innerText="0%";const c=e=>{l["aria-valuenow"]=`${e}`,l.style.width=`${e}%`,l.innerText=`${e}%`};a.appendChild(l),n.appendChild(a);let d=document.createElement("textarea");d.className="form-control",d.readOnly=!0,d.style.resize="both",d.style.width="500px",d.style.height="80px";const p=e=>{d.value+=`${e}\n`,d.scrollTop=d.scrollHeight};n.appendChild(d),document.body.appendChild(n);let u=document.createElement("script");u.src=this.bootJS.src,u.integrity=this.bootJS.integrity,u.crossOrigin="anonymous",document.body.appendChild(u);const m=e=>e.returnValue="downloading",f=this.downloadZip.bind(this);s.onclick=function(){s.disabled=!0,window.addEventListener("beforeunload",m),f(JSON.parse(r.value),c,p).then((()=>window.removeEventListener("beforeunload",m)))}}async downloadZip(e,t,n){if(!this.isDownloadObj(e))throw new Error("ダウンロード対象オブジェクトの型が不正");await this.script("https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"),await this.script("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.js"),await this.script("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/examples/zip-stream.js");const o=this,r=this.encodeFileName(e.id),i=streamSaver.createWriteStream(`${r}.zip`),s=new createWriter({async pull(i){let s=0;const a=(e,t)=>i.enqueue(new File(e,o.encodePath(t)));n(`@${e.id} 投稿:${e.postCount} ファイル:${e.fileCount}`),a([o.createHtmlFromBody(e.id,o.createRootHtmlFromPosts(e.posts))],`${r}/index.html`);for(const[i,l]of Object.entries(e.posts)){if(!l)continue;const c=`${r}/${i}`;if(a([l.info],`${c}/info.txt`),a([o.createHtmlFromBody(i,l.html)],`${c}/index.html`),l.cover){n(`download ${l.cover.filename}`);const e=await o.download(l.cover,1);e&&a([e],`${c}/${l.cover.filename}`)}let d=1,p=l.items.length;for(const r of l.items){n(`download ${r.filename} (${d++}/${p})`);const i=await o.download(r,1);i?a([i],`${c}/${r.filename}`):(console.error(`${r.filename}(${r.url})のダウンロードに失敗、読み飛ばすよ`),n(`${r.filename}のダウンロードに失敗`)),s++,await setTimeout((()=>t(100*s/e.fileCount|0)),0),await o.sleep(100)}n(`${100*s/e.fileCount|0}% (${s}/${e.fileCount})`)}i.close()}});if(window.WritableStream&&s.pipeTo)return s.pipeTo(i).then((()=>console.log("done writing")));const a=i.getWriter(),l=s.getReader(),c=()=>l.read().then((e=>e.done?a.close():a.write(e.value).then(c)));await c()}async sleep(e){return new Promise((t=>setTimeout(t,e)))}async script(e){return new Promise(((t,n)=>{let o=document.createElement("script");o.src=e,o.onload=()=>t(o),o.onerror=e=>n(e),document.head.appendChild(o)}))}async download({url:e,filename:t},n){if(n<0)return null;try{return await fetch(e).catch((e=>{throw new Error(e)})).then((e=>e.ok?e.blob():null))||await this.download({url:e,filename:t},n-1)}catch(o){return console.error(`通信エラー: ${t}, ${e}`),await this.sleep(1e3),await this.download({url:e,filename:t},n-1)}}encodeFileName(e){return e.replace(/\//g,"／").replace(/\\/g,"＼").replace(/,/g,"，").replace(/:/g,"：").replace(/\*/g,"＊").replace(/"/g,"“").replace(/</g,"＜").replace(/>/g,"＞").replace(/\|/g,"｜")}encodePath(e){return e.split("/").map((e=>this.encodeFileName(e))).join("/")}encodeLink(e){return e.split("/").map((e=>this.encodeFileName(e).replaceAll(/[;,/?:@&=+$#]/g,encodeURIComponent))).join("/")}isDownloadObj(e){switch(!0){case"object"!=typeof e:return console.error("ダウンロード用オブジェクトの型が不正(対象がobjectでない)",e),!1;case"object"!=typeof e.posts:return console.error("ダウンロード用オブジェクトの型が不正(postsがobjectでない)",e.posts),!1;case"number"!=typeof e.postCount:return console.error("ダウンロード用オブジェクトの型が不正(postCountが数値でない)",e.postCount),!1;case"number"!=typeof e.fileCount:return console.error("ダウンロード用オブジェクトの型が不正(fileCountが数値でない)",e.fileCount),!1;case"string"!=typeof e.id:return console.error("ダウンロード用オブジェクトの型が不正(idが文字列でない)",e.id),!1;case Object.keys(e.posts).some((e=>!e)):return console.error("ダウンロード用オブジェクトの型が不正(postsのキーに空文字が含まれる)",e.posts),!1}return!Object.values(e.posts).some((t=>{switch(!0){case"object"!=typeof t:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にobjectでないものが含まれる)",t,e.posts),!0;case"string"!=typeof t.info:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にinfoが文字列でないものが含まれる)",t.info,e.posts),!0;case"string"!=typeof t.html:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にhtmlが文字列でないものが含まれる)",t.html,e.posts),!0;case!Array.isArray(t.items):return console.error("ダウンロード用オブジェクトの型が不正(postsの値にitemsが配列でないものが含まれる)",t.items,e.posts),!0;case t.items.some((n=>{switch(!0){case"object"!=typeof n:return console.error("ダウンロード用オブジェクトの型が不正(postsのitemsの値にオブジェクトでないものが含まれる)",n,t.items),!0;case"string"!=typeof n.url:return console.error("ダウンロード用オブジェクトの型が不正(postsのitemsの値にurlが文字列でないものが含まれる)",n.url,t.items),!0;case"string"!=typeof n.filename:return console.error("ダウンロード用オブジェクトの型が不正(postsのitemsの値にfilenameが文字列でないものが含まれる)",n.filename,t.items),!0;case void 0===t.cover:return!1;case"object"!=typeof t.cover:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にcoverがobjectでないものが含まれる)",t.cover,e.posts),!0;case"string"!=typeof t.cover.url:return console.error("ダウンロード用オブジェクトの型が不正(postsのcoverの値にurlが文字列でないものが含まれる)",t.cover.url,t.cover),!0;case"string"!=typeof t.cover.filename:return console.error("ダウンロード用オブジェクトの型が不正(postsのcoverの値にfilenameが文字列でないものが含まれる)",t.cover.filename,t.cover),!0;default:return!1}})):return!0;default:return!1}}))}createRootHtmlFromPosts(e){return Object.entries(e).map((([e,t])=>{const n=this.encodeFileName(e);return`<a class="hl" href="${this.encodeLink(`./${n}/index.html`)}"><div class="root card">\n`+this.createCoverHtmlFromPost(n,t)+`<div class="card-body"><h5 class="card-title">${e}</h5></div>\n</div></a><br>\n`})).join("\n")}createCoverHtmlFromPost(e,t){return t.cover?`<img class="card-img-top gray-card" src="${this.encodeLink(`./${e}/${t.cover.filename}`)}"/>\n`:t.items.length>0?'<div class="carousel slide" data-bs-ride="carousel" data-interval="1000"><div class="carousel-inner">\n<div class="carousel-item active">'+t.items.map((t=>`<div class="d-flex justify-content-center gray-carousel"><img src="${this.encodeLink(`./${e}/${t.filename}`)}" class="d-block pd-carousel" height="180px"/></div>`)).join('</div>\n<div class="carousel-item">')+"</div>\n</div></div>\n":'<img class="card-img-top gray-card" />\n'}createHtmlFromBody(e,t){return`<!DOCTYPE html>\n<html lang="ja">\n<head>\n<meta charset="utf-8" />\n<title>${e}</title>\n<link href="${this.bootCSS.href}" rel="stylesheet" integrity="${this.bootCSS.integrity}" crossOrigin="anonymous">\n<style>div.main{width: 600px; float: none; margin: 0 auto}div.root{width: 400px}div.post{width: 600px}a.hl,a.hl:hover{color: inherit;text-decoration: none;}div.card{float: none; margin: 0 auto;}img.gray-card{height: 210px;background-color: gray;}div.gray-carousel{height: 210px; width: 400px;background-color: gray;}img.pd-carousel{height: 210px; padding: 15px;}</style>\n</head>\n<body>\n<div class="main">\n${t}\n</div>\n<script src="${this.bootJS.src}" integrity="${this.bootJS.integrity}" crossOrigin="anonymous"><\/script>\n</body></html>`}};async function l(){var e,t,o,r;if("https://downloads.fanbox.cc"===window.location.origin)return void await a.createDownloadUI("fanbox-downloader");if("https://www.fanbox.cc"===window.location.origin){const n=null===(e=window.location.href.match(/fanbox.cc\/@([^\/]*)/))||void 0===e?void 0:e[1],o=null===(t=window.location.href.match(/fanbox.cc\/@.*\/posts\/(\d*)/))||void 0===t?void 0:t[1];await c(n,o)}else{if(!window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//))return void alert(`ここどこですか(${window.location.href})`);{const e=null===(o=window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//))||void 0===o?void 0:o[1],t=null===(r=window.location.href.match(/.*\.fanbox\.cc\/posts\/(\d*)/))||void 0===r?void 0:r[1];await c(e,t)}}const i=JSON.stringify(n);console.log(i),await navigator.clipboard.writeText(i),alert("jsonをコピーしました。downloads.fanbox.ccで実行して貼り付けてね"),confirm("downloads.fanbox.ccに遷移する？")&&(document.location.href="https://downloads.fanbox.cc")}async function c(e,t){e?(n.id=e,t?m(u(t)):await async function(e){r=confirm("無料コンテンツを省く？");const t=prompt("取得制限数を入力 キャンセルで全て取得");o=t?Number.parseInt(t):null;let n=1,i=`https://api.fanbox.cc/post.listCreator?creatorId=${e}&limit=100`;for(;null!=i;n++)console.log(n+"回目"),i=d(i,!0),await a.sleep(100)}(e)):alert("しらないURL")}function d(e,t){const r=JSON.parse(p(e)),i=r.body.items;console.log("投稿の数:"+i.length);for(let e=0;e<i.length&&0!==o;e++)n.postCount++,t?(console.log(i[e]),m(i[e])):m(u(i[e].id));return r.body.nextUrl}function p(e){const t=new XMLHttpRequest;return t.open("GET",e,!1),t.withCredentials=!0,t.send(null),t.responseText}function u(e){return JSON.parse(p(`https://api.fanbox.cc/post.info?postId=${e}`)).body}function m(e){if(!e||r&&0===e.feeRequired)return;if(!e.body)return void console.log(`取得できませんでした(支援がたりない？)\nfeeRequired: ${e.feeRequired}@${e.id}`);const t=function(e){const t=function(e){const t=(()=>{switch(e.type){case"image":return`${e.body.text}\n`;case"file":return"not implemented\n";case"article":return e.body.blocks.filter((e=>"p"===e.type||"header"===e.type)).map((e=>e.text)).join("\n");default:return"undefined type\n"}})();return`id: ${e.id}\ntitle: ${e.title}\nfee: ${e.feeRequired}\npublishedDatetime: ${e.publishedDatetime}\nupdatedDatetime: ${e.updatedDatetime}\ntags: ${e.tags.join(", ")}\nexcerpt:\n${e.excerpt}\ntxt:\n${t}\n`}(e),o=e.coverImageUrl,r=o?{url:o,filename:`cover.${o.split(".").pop()}`}:void 0,a={info:t,items:[],html:function(e,t){return(t?b(t):"")+function(e){return`<h5>${e}</h5>\n`}(e.title)+(()=>{switch(e.type){case"image":return e.body.images.map(((t,n)=>b(i(t,e.title,n)))).join("<br>\n")+e.body.text.split("\n").map((e=>`<span>${e}</span>`)).join("<br>\n");case"file":return e.body.files.map(((t,n)=>g(s(t,e.title)))).join("<br>\n")+e.body.text.split("\n").map((e=>`<span>${e}</span>`)).join("<br>\n");case"article":let t=0,n=0,o=0;const r=y(e.body.fileMap,e.body.blocks),a=h(e.body.imageMap,e.body.blocks),l=function(e,t){const n=t.filter((e=>"embed"===e.type)).map((e=>e.embedId)),o=e=>{var t;return null!==(t=n.indexOf(e))&&void 0!==t?t:n.length};return Object.keys(e).sort(((e,t)=>o(e)-o(t))).map((t=>e[t]))}(e.body.embedMap,e.body.blocks);return e.body.blocks.map((c=>{switch(c.type){case"p":return`<span>${c.text}</span>`;case"header":return`<h2><span>${c.text}</span></h2>`;case"file":const d=s(r[n],e.title);return n++,g(d);case"image":const p=i(a[t],e.title,t);return t++,b(p);case"embed":return`<span>${l[o++]}</span>`;default:return console.error(`unknown block type: ${c.type}`)}})).join("<br>\n");case"text":return e.body.text?e.body.text.split("\n").map((e=>`<span>${e}</span>`)).join("<br>\n"):e.body.blocks?e.body.blocks.map((e=>{switch(e.type){case"header":return`<h2><span>${e.text}</span></h2>`;case"p":return`<span>${e.text}</span>`;default:return""}})).join("<br>\n"):"";default:return"undefined type\n"}})()}(e,null==r?void 0:r.filename),cover:r};let l=e.title;if(n.posts[l]){let e=2;for(;n.posts[`${l}_${e}`];)e++;l=`${l}_${e}`}return n.posts[l]=a,a}(e),a=e.title;if("image"===e.type){const n=e.body.images;for(let e=0;e<n.length;e++)f(t,n[e].originalUrl,i(n[e],a,e))}else if("file"===e.type){const n=e.body.files;for(let e=0;e<n.length;e++)f(t,n[e].url,s(n[e],a))}else if("article"===e.type){const n=h(e.body.imageMap,e.body.blocks);for(let e=0;e<n.length;e++)f(t,n[e].originalUrl,i(n[e],a,e));const o=y(e.body.fileMap,e.body.blocks);for(let e=0;e<o.length;e++)f(t,o[e].url,s(o[e],a))}else console.log(`不明なタイプ\n${e.type}@${e.id}`);null!=o&&o--}function f(e,t,o){n.fileCount++,e.items.push({url:t,filename:o})}function h(e,t){const n=t.filter((e=>"image"===e.type)).map((e=>e.imageId)),o=e=>{var t;return null!==(t=n.indexOf(e))&&void 0!==t?t:n.length};return Object.keys(e).sort(((e,t)=>o(e)-o(t))).map((t=>e[t]))}function y(e,t){const n=t.filter((e=>"file"===e.type)).map((e=>e.fileId)),o=e=>{var t;return null!==(t=n.indexOf(e))&&void 0!==t?t:n.length};return Object.keys(e).sort(((e,t)=>o(e)-o(t))).map((t=>e[t]))}function b(e){return`<a class="hl" href="${a.encodeLink(`./${e}"><div class="post card`)}">\n<img class="card-img-top" src="${a.encodeLink(`./${e}`)}"/>\n</div></a>`}function g(e){return`<span><a href="${a.encodeLink(`./${e}`)}">${e}</a></span>`}window.main=t.main})();