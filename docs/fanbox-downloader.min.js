var k=class{constructor(){this.audioExtension=/\.(mp3|m4a|ogg)$/,this.imageExtension=/\.(apng|avif|gif|jpg|jpeg|jfif|pjpeg|pjp|png|svg|webp)$/,this.videoExtension=/\.(mp4|webm|ogv)$/}isAudio(e){return e.match(this.audioExtension)!=null}isImage(e){return e.match(this.imageExtension)!=null}isVideo(e){return e.match(this.videoExtension)!=null}httpGetAs(e){let t=new XMLHttpRequest;return t.open("GET",e,!1),t.withCredentials=!0,t.send(null),JSON.parse(t.responseText)}encodeFileName(e){return e.replace(/\//g,"\uFF0F").replace(/\\/g,"\uFF3C").replace(/,/g,"\uFF0C").replace(/:/g,"\uFF1A").replace(/\*/g,"\uFF0A").replace(/"/g,"\u201C").replace(/</g,"\uFF1C").replace(/>/g,"\uFF1E").replace(/\|/g,"\uFF5C").trimEnd()}encodeURI(e){return this.encodeFileName(e).replaceAll(/[;,/?:@&=+$#]/g,encodeURIComponent)}splitExt(e){return e.split(/(?=\.[^.]+$)/)}getFileName(e,t,s,n,i){return s<=1?`${e}${t}`:i?`${e}_${n+1}${t}`:`${e}_${s-n}${t}`}toQuoted(e){return`'${e.replaceAll("'","\\'")}'`}createInformationFile(e){try{return{name:"info.json",content:[JSON.stringify(JSON.parse(e),null,"	")]}}catch{return{name:"info.txt",content:[e]}}}async sleep(e){return new Promise(t=>setTimeout(t,e))}async fetchWithLimit({url:e,name:t},s){if(s<0)return null;try{let n=await fetch(e).catch(i=>{throw new Error(i)}).then(i=>i.ok?i.blob():null);return n||await this.fetchWithLimit({url:e,name:t},s-1)}catch{return console.error(`\u901A\u4FE1\u30A8\u30E9\u30FC: ${t}, ${e}`),await this.sleep(1e3),await this.fetchWithLimit({url:e,name:t},s-1)}}async embedScript(e){return new Promise((t,s)=>{let n=document.createElement("script");n.src=e,n.onload=()=>t(n),n.onerror=i=>s(i),document.head.appendChild(n)})}},j=class{constructor(e,t){this.orderedPosts=[],this.url="#main",this.downloadObj={posts:{},id:e},this.utils=t}stringify(){var e;let t={posts:this.orderedPosts.map(s=>s.toJsonObjBy(this.downloadObj.posts)),id:this.downloadObj.id,url:this.url,tags:(e=this.tags)!==null&&e!==void 0?e:this.collectTags(),postCount:this.countPost(),fileCount:this.countFile()};return JSON.stringify(t)}setUrl(e){this.url=e}setTags(e){this.tags=e}addPost(e){let t=this.utils.encodeFileName(e);this.downloadObj.posts[t]===void 0&&(this.downloadObj.posts[t]=[]);let s={name:e,info:"",files:{},html:"",tags:[]};this.downloadObj.posts[t].push(s);let n=new T(s,this.utils);return this.orderedPosts.push(n),n}countPost(){return Object.values(this.downloadObj.posts).reduce((e,t)=>e+t.length,0)}countFile(){return Object.values(this.downloadObj.posts).reduce((e,t)=>e+t.reduce((s,n)=>s+Object.values(n.files).reduce((i,r)=>i+r.length,0),0),0)}collectTags(){let e=new Set;return Object.values(this.downloadObj.posts).forEach(t=>t.forEach(s=>s.tags.forEach(n=>e.add(n)))),[...e]}},T=class{constructor(e,t){this.postObj=e,this.utils=t}setInfo(e){this.postObj.info=e}setHtml(e){this.postObj.html=e}setTags(e){this.postObj.tags=e}setCover(e,t,s){let n={name:e,extension:t?`.${t}`:"",url:s};return this.postObj.cover=n,new N(n,this.utils)}addFile(e,t,s){let n=this.utils.encodeFileName(e);this.postObj.files[n]===void 0&&(this.postObj.files[n]=[]);let i={name:e,extension:t?`.${t}`:"",url:s};return this.postObj.files[n].push(i),new N(i,this.utils)}getAutoAssignedLinkTag(e){let t=e.getEncodedExtension();switch(!0){case this.utils.isAudio(t):return this.getAudioLinkTag(e);case this.utils.isImage(t):return this.getImageLinkTag(e);case this.utils.isVideo(t):return this.getVideoLinkTag(e);default:return this.getFileLinkTag(e)}}getAudioLinkTag(e){let t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">
<div class="card-header">${e.getOriginalName()}</div>
<audio class="card-img-top" src="${t}" controls/>
</div></a>`}getLinkTag(e,t){return`<a class="hl" href="${e}"><div class="post card text-center"><p class="pt-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-left" viewBox="0 0 16 16">
<path fill-rule="evenodd" d="M7.364 3.5a.5.5 0 0 1 .5-.5H14.5A1.5 1.5 0 0 1 16 4.5v10a1.5 1.5 0 0 1-1.5 1.5h-10A1.5 1.5 0 0 1 3 14.5V7.864a.5.5 0 1 1 1 0V14.5a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5v-10a.5.5 0 0 0-.5-.5H7.864a.5.5 0 0 1-.5-.5z"/>
<path fill-rule="evenodd" d="M0 .5A.5.5 0 0 1 .5 0h5a.5.5 0 0 1 0 1H1.707l8.147 8.146a.5.5 0 0 1-.708.708L1 1.707V5.5a.5.5 0 0 1-1 0v-5z"/>
</svg> ${t}</p></div></a>`}getFileLinkTag(e){return`<a class="hl" href="${this.getCurrentFilePath(e)}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card text-center"><p class="pt-2">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
</svg> ${e.getOriginalName()+e.getOriginalExtension()}</p></div></a>`}getImageLinkTag(e){let t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">
<img class="card-img-top" src="${t}" alt="${e.getOriginalName()}"/>
</div></a>`}getVideoLinkTag(e){let t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">
<video class="card-img-top" src="${t}" controls/>
</div></a>`}getCurrentFilePath(e){let t=e.getEncodedName();if(e.equals(this.postObj.cover)){let i=this.utils.getFileName(t,e.getEncodedExtension(),1,0,!0);return`./${this.utils.encodeURI(i)}`}if(this.postObj.files[t]===void 0)throw new Error(`file object is undefined: ${e.getOriginalName()}`);let s=this.postObj.files[t].findIndex(i=>e.equals(i));if(s<0)throw new Error(`file object is not found: ${e.getOriginalName()}`);let n=this.utils.getFileName(t,e.getEncodedExtension(),this.postObj.files[t].length,s,!0);return`./${this.utils.encodeURI(n)}`}toJsonObjBy(e){var t;let s=this.utils.encodeFileName(this.postObj.name),n=(t=e[s])===null||t===void 0?void 0:t.indexOf(this.postObj);if(n===void 0||n<0)throw new Error(`post object is not found: ${this.postObj.name}`);let i=this.utils.getFileName(s,"",e[s].length,n,!1),r=this.postObj.cover?{url:this.postObj.cover.url,name:this.utils.getFileName(this.postObj.cover.name,this.postObj.cover.extension,1,0,!0)}:void 0;return{originalName:this.postObj.name,encodedName:i,informationText:this.postObj.info,htmlText:this.postObj.html,files:this.collectFiles(),tags:this.postObj.tags,cover:r}}collectFiles(){let e=[];for(let[t,s]of Object.entries(this.postObj.files)){let n=0;for(let i of s){let r=i.extension?this.utils.encodeFileName(i.extension):"",a=this.utils.getFileName(t,r,s.length,n++,!0);e.push({url:i.url,originalName:i.name,encodedName:a})}}return e}},N=class{constructor(e,t){this.fileObj=e,this.utils=t}getEncodedName(){return this.utils.encodeFileName(this.fileObj.name)}getEncodedExtension(){return this.utils.encodeFileName(this.fileObj.extension)}getOriginalName(){return this.fileObj.name}getOriginalExtension(){return this.fileObj.extension}getUrl(){return this.fileObj.url}equals(e){return typeof e!="object"?!1:e.name===this.fileObj.name&&e.url===this.fileObj.url}},E=class{constructor(e){this.bootCSS={href:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css",integrity:"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"},this.bootJS={src:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js",integrity:"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"},this.vueJS={src:"https://unpkg.com/vue@3.2.28/dist/vue.global.js"},this.utils=e}async createDownloadUI(e){document.head.innerHTML="",document.body.innerHTML="",document.getElementsByTagName("html")[0].style.height="100%",document.body.style.height="100%",document.body.style.margin="0",document.title=e;let t=document.createElement("link");t.href=this.bootCSS.href,t.rel="stylesheet",t.integrity=this.bootCSS.integrity,t.crossOrigin="anonymous",document.head.appendChild(t);let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.flexDirection="column",s.style.height="100%";let n=document.createElement("div");n.className="input-group mb-2",n.style.width="400px";let i=document.createElement("input");i.type="text",i.className="form-control",i.placeholder="\u3053\u3053\u306BJSON\u3092\u8CBC\u308A\u4ED8\u3051",n.appendChild(i);let r=document.createElement("div");r.className="input-group-append";let a=document.createElement("button");a.className="btn btn-outline-secondary btn-labeled",a.type="button",a.innerText="Download",r.appendChild(a),n.appendChild(r),s.appendChild(n);let p=document.createElement("div");p.className="progress mb-3",p.style.width="400px";let d=document.createElement("div");d.className="progress-bar",d.role="progressbar",d["aria-valuemin"]="0",d["aria-valuemax"]="100",d["aria-valuenow"]="0",d.style.width="0%",d.innerText="0%";let u=h=>{d["aria-valuenow"]=`${h}`,d.style.width=`${h}%`,d.innerText=`${h}%`};p.appendChild(d),s.appendChild(p);let x=document.createElement("div");x.style.width="350px";let v=document.createElement("div");v.className="form-check float-start";let g=document.createElement("input");g.className="form-check-input",g.type="checkbox",g.id="LogCheck",g.checked=!0,v.appendChild(g);let w=document.createElement("label");w.className="form-check-label",w.for="LogCheck",w.innerText="\u30ED\u30B0\u3092\u81EA\u52D5\u30B9\u30AF\u30ED\u30FC\u30EB",v.appendChild(w),x.appendChild(v);let f=document.createElement("div");f.className="float-end",f.innerText="\u6B8B\u308A\u304A\u3088\u305D -:--";let l=h=>f.innerText=`\u6B8B\u308A\u304A\u3088\u305D ${h}`;x.appendChild(f),s.appendChild(x);let m=document.createElement("textarea");m.className="form-control",m.readOnly=!0,m.style.resize="both",m.style.width="500px",m.style.height="80px";let c=h=>{m.value+=`${h}
`,g.checked&&(m.scrollTop=m.scrollHeight)};s.appendChild(m),document.body.appendChild(s);let y=document.createElement("script");y.src=this.bootJS.src,y.integrity=this.bootJS.integrity,y.crossOrigin="anonymous",document.body.appendChild(y);let O=this.downloadZip.bind(this);a.onclick=async()=>{a.disabled=!0;let h=$=>$.returnValue="downloading";window.addEventListener("beforeunload",h);try{await O(JSON.parse(i.value),u,c,l)}catch($){c("\u30A8\u30E9\u30FC\u51FA\u305F"),console.error($)}finally{window.removeEventListener("beforeunload",h)}}}async downloadZip(e,t,s,n){if(!this.isDownloadJsonObj(e))throw new Error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u5BFE\u8C61\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63");let i=this,r=this.utils;await r.embedScript("https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"),await r.embedScript("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.js"),await r.embedScript("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/examples/zip-stream.js");let a=r.encodeFileName(e.id),p=streamSaver.createWriteStream(`${a}.zip`),d=new createWriter({async pull(g){let w=Math.floor(Date.now()/1e3),f=0,l=(c,y)=>g.enqueue(new File(c,`${a}/${y}`));s(`@${e.id} \u6295\u7A3F:${e.postCount} \u30D5\u30A1\u30A4\u30EB:${e.fileCount}`),l([i.createRootHtmlFromPosts(e)],"index.html");let m=0;for(let c of e.posts){s(`${c.originalName} (${++m}/${e.postCount})`);let y=r.createInformationFile(c.informationText);if(l(y.content,`${c.encodedName}/${r.encodeFileName(y.name)}`),l([i.createHtmlFromBody(c.originalName,c.htmlText)],`${c.encodedName}/index.html`),c.cover){s(`download ${c.cover.name}`);let h=await r.fetchWithLimit(c.cover,1);h&&l([h],`${c.encodedName}/${c.cover.name}`)}let O=0;for(let h of c.files){s(`download ${h.encodedName} (${++O}/${c.files.length})`);let $=await r.fetchWithLimit({url:h.url,name:h.encodedName},1);$?l([$],`${c.encodedName}/${h.encodedName}`):(console.error(`${h.encodedName}(${h.url})\u306E\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u306B\u5931\u6557\u3001\u8AAD\u307F\u98DB\u3070\u3059\u3088`),s(`${h.encodedName}\u306E\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u306B\u5931\u6557`)),f++,setTimeout(()=>{let F=Math.floor(Math.abs(Math.floor(Date.now()/1e3)-w)*(e.fileCount-f)/f),L=F/(60*60)|0,P=Math.ceil((F-60*60*L)/60);n(`${L}:${("00"+P).slice(-2)}`),t(f*100/e.fileCount|0)},0),await r.sleep(100)}}g.close()}});if(window.WritableStream&&d.pipeTo)return d.pipeTo(p).then(()=>console.log("done writing"));let u=p.getWriter(),x=d.getReader(),v=()=>x.read().then(g=>g.done?u.close():u.write(g.value).then(v));await v()}isDownloadJsonObj(e){switch(!0){case typeof e!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(\u5BFE\u8C61\u304Cobject\u3067\u306A\u3044)",e),!1;case typeof e.postCount!="number":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(postCount\u304C\u6570\u5024\u3067\u306A\u3044)",e.postCount),!1;case typeof e.fileCount!="number":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(fileCount\u304C\u6570\u5024\u3067\u306A\u3044)",e.fileCount),!1;case typeof e.id!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(id\u304C\u6587\u5B57\u5217\u3067\u306A\u3044)",e.id),!1;case typeof e.url!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(url\u304C\u6587\u5B57\u5217\u3067\u306A\u3044)",e.url),!1;case!Array.isArray(e.posts):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u304C\u914D\u5217\u3067\u306A\u3044)",e.posts),!1;case!Array.isArray(e.tags):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(tags\u304C\u914D\u5217\u3067\u306A\u3044)",e.tags),!1}return!e.posts.some(t=>{switch(!0){case typeof t!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Bobject\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t,e.posts),!0;case typeof t.informationText!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306BinformationText\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.informationText,e.posts),!0;case typeof t.htmlText!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306BhtmlText\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.htmlText,e.posts),!0;case!Array.isArray(t.files):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Bfiles\u304C\u914D\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.files,e.posts),!0;case!Array.isArray(t.tags):return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Btags\u304C\u914D\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.tags,e.posts),!0;case t.files.some(s=>{var n,i,r,a;switch(!0){case typeof s!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306B\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",s,t.files),!0;case typeof s.url!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306Burl\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",s.url,t.files),!0;case typeof s.originalName!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306BoriginalName\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",s.originalName,t.files),!0;case typeof s.encodedName!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Efiles\u306E\u5024\u306BencodedName\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",s.encodedName,t.files),!0;case t.cover===void 0:return!1;case typeof t.cover!="object":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306E\u5024\u306Bcover\u304Cobject\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",t.cover,e.posts),!0;case typeof((n=t.cover)===null||n===void 0?void 0:n.url)!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Ecover\u306E\u5024\u306Burl\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",(i=t.cover)===null||i===void 0?void 0:i.url,t.cover),!0;case typeof((r=t.cover)===null||r===void 0?void 0:r.name)!="string":return console.error("\u30C0\u30A6\u30F3\u30ED\u30FC\u30C9\u7528\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u578B\u304C\u4E0D\u6B63(posts\u306Ecover\u306E\u5024\u306Bname\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u3082\u306E\u304C\u542B\u307E\u308C\u308B)",(a=t.cover)===null||a===void 0?void 0:a.name,t.cover),!0;default:return!1}}):return!0;default:return!1}})}createRootHtmlFromPosts(e){let t=`<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>${e.id}</title>
<link href="${this.bootCSS.href}" rel="stylesheet" integrity="${this.bootCSS.integrity}" crossOrigin="anonymous">
<style>div.main{width: 600px; float: none; margin: 65px auto 0}div.root{width: 400px}div.post{width: 600px}a.hl,a.hl:hover{color: inherit;text-decoration: none;}div.card{float: none; margin: 0 auto;}img.gray-card{height: 210px;background-color: gray;}div.gray-carousel{height: 210px; width: 400px;background-color: gray;}img.pd-carousel{height: 210px; padding: 15px;}</style>
</head>
<body>
<div class="main" id="main">
`,s=`<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top"><div class="container-fluid">
<a class="navbar-brand" href="${e.url}">${e.id}</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#dd" aria-controls="dd" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="dd"><ul class="navbar-nav">
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href="#" id="navbarDarkDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tags</a>
<ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dd">
<li v-for="(tag,i) in [${e.tags.map(i=>this.utils.toQuoted(i)).join(",")}]">
 <div class="form-check mx-1">
<input class="form-check-input" type="checkbox" v-model="selected" :value="tag" :id="'box'+(i+1)">
<label class="form-check-label" :for="'box'+(i+1)">{{tag}}</label>
</div>
</li>
</ul>
</li>
</ul></div>
</div></nav>

`+e.posts.map(i=>`<div v-show="isVisible([${i.tags.map(r=>this.utils.toQuoted(r)).join(", ")}], selected)">
<a class="hl" href="./${this.utils.encodeURI(i.encodedName)}/index.html"><div class="root card">
`+this.createCoverHtmlFromPost(i)+`<div class="card-body"><h5 class="card-title">${i.originalName}</h5></div>
</div></a><br>
</div>
`).join(`
`),n=`
</div>
<script src="${this.vueJS.src}"><\/script>
<script>
Vue.createApp({
data() {return { selected: [] }},methods: {
 isVisible(tags, selected) {
  if (!selected.length) return true
  return selected.every(it => tags.includes(it))
 }
}
}).mount('#main')
<\/script>
<script src="${this.bootJS.src}" integrity="${this.bootJS.integrity}" crossOrigin="anonymous"><\/script>
</body></html>`;return t+s+n}createCoverHtmlFromPost(e){let t=`./${this.utils.encodeURI(e.encodedName)}/`;if(e.cover)return`<img class="card-img-top gray-card" src="${t}${this.utils.encodeURI(e.cover.name)}" alt="\u30AB\u30D0\u30FC\u753B\u50CF"/>
`;let s=e.files.filter(n=>this.utils.isImage(n.encodedName));return s.length>0?`<div class="carousel slide" data-bs-ride="carousel" data-interval="1000"><div class="carousel-inner">
<div class="carousel-item active">`+s.map(n=>`<div class="d-flex justify-content-center gray-carousel"><img src="${t}${this.utils.encodeURI(n.encodedName)}" class="d-block pd-carousel" height="180px"/></div>`).join(`</div>
<div class="carousel-item">`)+`</div>
</div></div>
`:`<img class="card-img-top gray-card"/>
`}createHtmlFromBody(e,t){return`<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>${e}</title>
<link href="${this.bootCSS.href}" rel="stylesheet" integrity="${this.bootCSS.integrity}" crossOrigin="anonymous">
<style>div.main{width: 600px; float: none; margin: 0 auto}div.root{width: 400px}div.post{width: 600px}a.hl,a.hl:hover{color: inherit;text-decoration: none;}div.card{float: none; margin: 0 auto;}img.gray-card{height: 210px;background-color: gray;}div.gray-carousel{height: 210px; width: 400px;background-color: gray;}img.pd-carousel{height: 210px; padding: 15px;}</style>
</head>
<body>
<div class="main">
${t}
</div>
<script src="${this.bootJS.src}" integrity="${this.bootJS.integrity}" crossOrigin="anonymous"><\/script>
</body></html>`}};var b=class o{constructor(e,t){this.userId=e;this.feeMap=t;this.isIgnoreFree=!1;this.fees=[];this.tags=[];this.isLimitAvailable=!1;this.limit=0;this.downloadObject=new j(e,o.utils)}static{this.utils=new k}static{this.isExportJson=!0}addFee(e){this.fees=[...new Set([...this.fees,e])]}addTags(...e){this.tags=[...new Set([...this.tags,...e])]}applyTags(){let e=this.fees.sort((s,n)=>s-n).map(s=>this.getTagByFee(s)),t=this.tags.filter(s=>!e.includes(s));this.downloadObject.setTags([...e,...t])}getTagByFee(e){return this.feeMap.get(e)??(e>0?`${e}\u5186`:"\u7121\u6599")+"\u30D7\u30E9\u30F3"}setLimitAvailable(e){this.isLimitAvailable=e}isLimitValid(){return this.isLimitAvailable?this.limit>0:!0}decrementLimit(){this.isLimitAvailable&&this.limit--}setLimit(e){this.isLimitAvailable&&(this.limit=e)}};async function q(){let o;if(window.location.origin==="https://downloads.fanbox.cc"){await new E(b.utils).createDownloadUI("fanbox-downloader");return}else if(window.location.origin==="https://www.fanbox.cc"){let s=window.location.href.match(/fanbox.cc\/@([^\/]*)/)?.[1],n=window.location.href.match(/fanbox.cc\/@.*\/posts\/(\d*)/)?.[1];o=await S(s,n)}else if(window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//)){let s=window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//)?.[1],n=window.location.href.match(/.*\.fanbox\.cc\/posts\/(\d*)/)?.[1];o=await S(s,n)}else{alert(`\u3053\u3053\u3069\u3053\u3067\u3059\u304B(${window.location.href})`);return}if(!o)return;let e=o.stringify();console.log(e);let t=()=>{alert("json\u3092\u30B3\u30D4\u30FC\u3057\u307E\u3057\u305F\u3002downloads.fanbox.cc\u3067\u5B9F\u884C\u3057\u3066\u8CBC\u308A\u4ED8\u3051\u3066\u306D"),confirm("downloads.fanbox.cc\u306B\u9077\u79FB\u3059\u308B\uFF1F")&&(document.location.href="https://downloads.fanbox.cc")};try{await navigator.clipboard.writeText(e),t()}catch{document.body.addEventListener("click",()=>{navigator.clipboard.writeText(e).then(()=>t()).catch(()=>alert("json\u30B3\u30D4\u30FC\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u3082\u3046\u4E00\u5EA6\u5B9F\u884C\u3059\u308B\u304B\u30B3\u30F3\u30BD\u30FC\u30EB\u304B\u3089\u30B3\u30D4\u30FC\u3057\u3066\u306D"))},{once:!0}),alert("json\u30B3\u30D4\u30FC\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u753B\u9762\u306E\u9069\u5F53\u306A\u3068\u3053\u3092\u30AF\u30EA\u30C3\u30AF\uFF01")}}async function S(o,e){if(!o){alert("\u3057\u3089\u306A\u3044URL");return}let t=b.utils.httpGetAs(`https://api.fanbox.cc/plan.listCreator?creatorId=${o}`).body,s=new Map;t?.forEach(r=>s.set(r.fee,r.title));let n=new b(o,s);n.downloadObject.setUrl(`https://www.fanbox.cc/@${o}`);let i=b.utils.httpGetAs(`https://api.fanbox.cc/tag.getFeatured?creatorId=${o}`).body?.map(r=>r.tag)??[];return n.addTags(...i),e?C(n,A(e)):await D(n),n.applyTags(),n.downloadObject}async function D(o){o.isIgnoreFree=confirm("\u7121\u6599\u30B3\u30F3\u30C6\u30F3\u30C4\u3092\u7701\u304F\uFF1F");let e=prompt("\u53D6\u5F97\u5236\u9650\u6570\u3092\u5165\u529B \u30AD\u30E3\u30F3\u30BB\u30EB\u3067\u5168\u3066\u53D6\u5F97");if(e){let s=Number.parseInt(e);s&&(o.setLimitAvailable(!0),o.setLimit(s))}let t=b.utils.httpGetAs(`https://api.fanbox.cc/post.paginateCreator?creatorId=${o.userId}`).body;for(let s=0;s<t.length;s++)console.log(`${s+1}\u56DE\u76EE`),await I(o,t[s]),await b.utils.sleep(10)}async function I(o,e){let t=b.utils.httpGetAs(e).body;console.log(`\u6295\u7A3F\u306E\u6570:${t.length}`);for(let s of t)if(o.isLimitValid())s.body?C(o,s):s.isRestricted||(await b.utils.sleep(10),C(o,A(s.id)));else break}function A(o){return b.utils.httpGetAs(`https://api.fanbox.cc/post.info?postId=${o}`).body}function C(o,e){if(!e||o.isIgnoreFree&&e.feeRequired===0)return;if(!e.body||e.isRestricted){console.log(`\u53D6\u5F97\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F(\u652F\u63F4\u304C\u305F\u308A\u306A\u3044\uFF1F)
feeRequired: ${e.feeRequired}@${e.id}`);return}let t=e.title,s=o.downloadObject.addPost(t);s.setTags([o.getTagByFee(e.feeRequired),...e.tags]),o.addFee(e.feeRequired),o.addTags(...e.tags);let n=(a=>{if(a){let p=a.split(".").pop()??"";return`${s.getImageLinkTag(s.setCover("cover",p,a))}<h5>${t}</h5>
`}return`<h5>${t}</h5>
<br>
`})(e.coverImageUrl),i;switch(e.type){case"image":{let p=e.body.images.map(u=>s.addFile(t,u.extension,u.originalUrl)).map(u=>s.getImageLinkTag(u)).join(`<br>
`),d=e.body.text.split(`
`).map(u=>`<span>${u}</span>`).join(`<br>
`);s.setHtml(n+p+`<br>
`+d),i=`${e.body.text}
`;break}case"file":{let p=e.body.files.map(u=>s.addFile(u.name,u.extension,u.url)).map(u=>s.getAutoAssignedLinkTag(u)).join(`<br>
`),d=e.body.text.split(`
`).map(u=>`<span>${u}</span>`).join(`<br>
`);s.setHtml(n+p+`<br>
`+d),i=`${e.body.text}
`;break}case"article":{let a=B(e.body.imageMap,e.body.blocks).map(l=>s.addFile(t,l.extension,l.originalUrl)),p=J(e.body.fileMap,e.body.blocks).map(l=>s.addFile(l.name,l.extension,l.url)),d=R(e.body.embedMap,e.body.blocks),u=U(e.body.urlEmbedMap,e.body.blocks),x=0,v=0,g=0,w=0,f=e.body.blocks.map(l=>{switch(l.type){case"p":return`<span>${l.text}</span>`;case"header":return`<h2><span>${l.text}</span></h2>`;case"file":return s.getAutoAssignedLinkTag(p[v++]);case"image":return s.getImageLinkTag(a[x++]);case"embed":return`<span>${JSON.stringify(d[g++])}</span>`;case"url_embed":{let m=u[w++];switch(m.type){case"default":return s.getLinkTag(m.url,m.host);case"html":case"html.card":let c=m.html.match(/<iframe.*src="(http.*)"/)?.[1];return c?s.getLinkTag(c,"iframe link"):`
${m.html}

`;case"fanbox.post":let y=`https://www.fanbox.cc/@${m.postInfo.creatorId}/posts/${m.postInfo.id}`;return s.getLinkTag(y,m.postInfo.title);default:return`<span>${JSON.stringify(m)}</span>`}}default:return console.error(`unknown block type: ${l.type}`)}}).join(`<br>
`);s.setHtml(n+f),i=e.body.blocks.filter(l=>l.type==="p"||l.type==="header").map(l=>l.text).join(`
`)+`
`;break}case"text":{let a=e.body.text.split(`
`).map(p=>`<span>${p}</span>`).join(`<br>
`);i=e.body.text,s.setHtml(n+a);break}default:i=`\u4E0D\u660E\u306A\u30BF\u30A4\u30D7
${e.type}@${e.id}
`,console.log(`\u4E0D\u660E\u306A\u30BF\u30A4\u30D7
${e.type}@${e.id}`);break}let r={postId:e.id,title:e.title,creatorId:e.creatorId,fee:e.feeRequired,publishedDatetime:e.publishedDatetime,updatedDatetime:e.updatedDatetime,tags:e.tags,likeCount:e.likeCount,commentCount:e.commentCount};if(b.isExportJson)s.setInfo(JSON.stringify({...r,parsedText:i}));else{let a=Object.keys(r).map(p=>`${p}:${JSON.stringify(r[p])}`).join(`
`);s.setInfo(a+`
parsedText:
`+i)}o.decrementLimit()}function B(o,e){let t=e.filter(n=>n.type==="image").map(n=>n.imageId),s=n=>t.indexOf(n)??t.length;return Object.keys(o).sort((n,i)=>s(n)-s(i)).map(n=>o[n])}function J(o,e){let t=e.filter(n=>n.type==="file").map(n=>n.fileId),s=n=>t.indexOf(n)??t.length;return Object.keys(o).sort((n,i)=>s(n)-s(i)).map(n=>o[n])}function R(o,e){let t=e.filter(n=>n.type==="embed").map(n=>n.embedId),s=n=>t.indexOf(n)??t.length;return Object.keys(o).sort((n,i)=>s(n)-s(i)).map(n=>o[n])}function U(o,e){let t=e.filter(n=>n.type==="url_embed").map(n=>n.urlEmbedId),s=n=>t.indexOf(n)??t.length;return Object.keys(o).sort((n,i)=>s(n)-s(i)).map(n=>o[n])}export{q as main};
