let dlList={items:[],postCount:0,fileCount:0},limit=0,isIgnoreFree=!1,isEco=!0;async function main(){if("https://downloads.fanbox.cc"===window.location.origin){document.body.innerHTML="";let t=document.createElement("input");t.type="text";let e=document.createElement("input");return e.type="button",e.value="ok",document.body.appendChild(t),document.body.appendChild(e),void(e.onclick=function(){JSON.parse(t.value).items.forEach(t=>{createLink(t.url,t.filename)}),startDownload()})}if("https://www.fanbox.cc"===window.location.origin){const t=window.location.href.match(/fanbox.cc\/@.*\/posts\/(\d*)/);if(t)addByPostInfo(getPostInfoById(t[1]));else{const t=window.location.href.match(/fanbox.cc\/@(.*)/)[1];null!=t?getItemsById(t):alert("しらないURL")}}else{if(!window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//))return void alert(`ここどこですか(${window.location.href})`);{const t=window.location.href.match(/.*\.fanbox\.cc\/posts\/(\d*)/);if(t)addByPostInfo(getPostInfoById(t[1]));else{const t=window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//)[1];await getItemsById(t)}}}const t=JSON.stringify(dlList);console.log(t),await navigator.clipboard.writeText(t),alert("jsonをコピーしました。downloads.fanbox.ccで実行して貼り付けてね")}function addByPostListUrl(t,e){const o=JSON.parse(fetchUrl(t)),n=o.body.items;console.log("投稿の数:"+n.length);for(let t=0;t<n.length&&0!==limit;t++)dlList.postCount++,!0===e?(console.log(n[t]),addByPostInfo(n[t])):addByPostInfo(getPostInfoById(n[t].id));return o.body.nextUrl}function fetchUrl(t){const e=new XMLHttpRequest;return e.open("GET",t,!1),e.withCredentials=!0,e.send(null),e.responseText}async function getItemsById(t){dlList.items=[],isIgnoreFree=confirm("無料コンテンツを省く？"),limit=prompt("取得制限数を入力 キャンセルで全て取得");let e,o=1;for(e=`https://api.fanbox.cc/post.listCreator?creatorId=${t}&limit=100`;null!=e;o++)console.log(o+"回目"),e=addByPostListUrl(e,isEco),await setTimeout(()=>{},100)}function getPostInfoById(t){return JSON.parse(fetchUrl(`https://api.fanbox.cc/post.info?postId=${t}`)).body}function addByPostInfo(t){const e=t.title,o=t.publishedDatetime;if(!isIgnoreFree||0!==t.feeRequired)if(null!=t.body){if("image"===t.type){const n=t.body.images;for(let t=0;t<n.length;t++)addUrl(n[t].originalUrl,`${o} ${e} ${t+1}.${n[t].extension}`)}else if("file"===t.type){const n=t.body.files;for(let t=0;t<n.length;t++)addUrl(n[t].url,`${o} ${e} ${n[t].name}.${n[t].extension}`)}else if("article"===t.type){const n=t.body.imageMap,i=Object.keys(n);for(let t=0;t<i.length;t++)addUrl(n[i[t]].originalUrl,`${o} ${e} ${t+1}.${n[i[t]].extension}`);const l=t.body.fileMap,s=Object.keys(l);for(let t=0;t<s.length;t++)addUrl(l[s[t]].url,`${o} ${e} ${l[s[t]].name}.${l[s[t]].extension}`)}else console.log(`不明なタイプ\n${t.type}@${t.id}`);null!=limit&&limit--}else console.log(`取得できませんでした(支援がたりない？)\nfeeRequired: ${t.feeRequired}@${t.id}`)}function addUrl(t,e){const o={};o.url=t,o.filename=e,dlList.fileCount++,dlList.items.push(o)}function createLink(t,e){const o=document.createElement("a");document.body.appendChild(o),o.href=t,o.download=e}function startDownload(){const t=document.querySelectorAll("a");let e=0;const o=setInterval(function(){t[e].click(),++e>=t.length&&clearInterval(o)},300)}
