var e={d:(t,o)=>{for(var n in o)e.o(o,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:o[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{D:()=>c});class o{constructor(e,t){this.orderedPosts=[],this.downloadObj={posts:{},id:e},this.utils=t}stringify(){const e={posts:this.orderedPosts.map((e=>e.toJsonObjBy(this.downloadObj.posts))),id:this.downloadObj.id,postCount:this.countPost(),fileCount:this.countFile()};return JSON.stringify(e)}addPost(e){const t=this.utils.encodeFileName(e);void 0===this.downloadObj.posts[t]&&(this.downloadObj.posts[t]=[]);const o={name:e,info:"",files:{},html:""};this.downloadObj.posts[t].push(o);const s=new n(o,this.utils);return this.orderedPosts.push(s),s}countPost(){return Object.values(this.downloadObj.posts).reduce(((e,t)=>e+t.length),0)}countFile(){return Object.values(this.downloadObj.posts).reduce(((e,t)=>e+t.reduce(((e,t)=>e+Object.values(t.files).reduce(((e,t)=>e+t.length),0)),0)),0)}}class n{constructor(e,t){this.postObj=e,this.utils=t}setInfo(e){this.postObj.info=e}setHtml(e){this.postObj.html=e}setCover(e,t,o){const n={name:e,extension:t?`.${t}`:"",url:o};return this.postObj.cover=n,new s(n,this.utils)}addFile(e,t,o){const n=this.utils.encodeFileName(e);void 0===this.postObj.files[n]&&(this.postObj.files[n]=[]);const i={name:e,extension:t?`.${t}`:"",url:o};return this.postObj.files[n].push(i),new s(i,this.utils)}getImageLinkTag(e){const t=this.getCurrentFilePath(e);return`<a class="hl" href="${t}" download="${e.getEncodedName()+e.getEncodedExtension()}"><div class="post card">\n<img class="card-img-top" src="${t}" alt="${e.getOriginalName()}"/>\n</div></a>`}getFileLinkTag(e){return`<span><a href="${this.getCurrentFilePath(e)}" download="${e.getEncodedName()+e.getEncodedExtension()}">${e.getOriginalName()}</a></span>`}getCurrentFilePath(e){const t=e.getEncodedName();if(e.equals(this.postObj.cover)){const o=this.utils.getFileName(t,e.getEncodedExtension(),1,1);return`./${this.utils.encodeURI(o)}`}if(void 0===this.postObj.files[t])throw new Error(`file object is undefined: ${e.getOriginalName()}`);const o=this.postObj.files[t].findIndex((t=>e.equals(t)));if(o<0)throw new Error(`file object is not found: ${e.getOriginalName()}`);const n=this.utils.getFileName(t,e.getEncodedExtension(),this.postObj.files[t].length,o+1);return`./${this.utils.encodeURI(n)}`}toJsonObjBy(e){var t;const o=this.utils.encodeFileName(this.postObj.name),n=null===(t=e[o])||void 0===t?void 0:t.indexOf(this.postObj);if(void 0===n||n<0)throw new Error(`post object is not found: ${this.postObj.name}`);const s=this.utils.getFileName(o,"",e[o].length,n+1),i=this.postObj.cover?{url:this.postObj.cover.url,name:this.utils.getFileName(this.postObj.cover.name,this.postObj.cover.extension,1,1)}:void 0;return{originalName:this.postObj.name,encodedName:s,informationText:this.postObj.info,htmlText:this.postObj.html,files:this.collectFiles(),cover:i}}collectFiles(){const e=[];for(const[t,o]of Object.entries(this.postObj.files)){let n=0;for(const s of o){n++;const i=s.extension?this.utils.encodeFileName(s.extension):"",r=this.utils.getFileName(t,i,o.length,n);e.push({url:s.url,originalName:s.name,encodedName:r})}}return e}}class s{constructor(e,t){this.fileObj=e,this.utils=t}getEncodedName(){return this.utils.encodeFileName(this.fileObj.name)}getEncodedExtension(){return this.fileObj.extension?this.utils.encodeFileName(this.fileObj.extension):""}getOriginalName(){return this.fileObj.name}getUrl(){return this.fileObj.url}equals(e){return"object"==typeof e&&e.name===this.fileObj.name&&e.url===this.fileObj.url}}class i{constructor(e){this.bootCSS={href:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css",integrity:"sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"},this.bootJS={src:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js",integrity:"sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"},this.utils=e}async createDownloadUI(e){document.head.innerHTML="",document.body.innerHTML="",document.getElementsByTagName("html")[0].style.height="100%",document.body.style.height="100%",document.body.style.margin="0",document.title=e;let t=document.createElement("link");t.href=this.bootCSS.href,t.rel="stylesheet",t.integrity=this.bootCSS.integrity,t.crossOrigin="anonymous",document.head.appendChild(t);let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.flexDirection="column",o.style.height="100%";let n=document.createElement("div");n.className="input-group mb-2",n.style.width="400px";let s=document.createElement("input");s.type="text",s.className="form-control",s.placeholder="ここにJSONを貼り付け",n.appendChild(s);let i=document.createElement("div");i.className="input-group-append";let r=document.createElement("button");r.className="btn btn-outline-secondary btn-labeled",r.type="button",r.innerText="Download",i.appendChild(r),n.appendChild(i),o.appendChild(n);let a=document.createElement("div");a.className="progress mb-3",a.style.width="400px";let l=document.createElement("div");l.className="progress-bar",l.role="progressbar",l["aria-valuemin"]="0",l["aria-valuemax"]="100",l["aria-valuenow"]="0",l.style.width="0%",l.innerText="0%";const c=e=>{l["aria-valuenow"]=`${e}`,l.style.width=`${e}%`,l.innerText=`${e}%`};a.appendChild(l),o.appendChild(a);let d=document.createElement("div");d.style.width="350px";let p=document.createElement("div");p.className="form-check float-start";let u=document.createElement("input");u.className="form-check-input",u.type="checkbox",u.id="LogCheck",u.checked=!0,p.appendChild(u);let m=document.createElement("label");m.className="form-check-label",m.for="LogCheck",m.innerText="ログを自動スクロール",p.appendChild(m),d.appendChild(p);let h=document.createElement("div");h.className="float-end",h.innerText="残りおよそ -:--";const f=e=>h.innerText=`残りおよそ ${e}`;d.appendChild(h),o.appendChild(d);let g=document.createElement("textarea");g.className="form-control",g.readOnly=!0,g.style.resize="both",g.style.width="500px",g.style.height="80px";const b=e=>{g.value+=`${e}\n`,u.checked&&(g.scrollTop=g.scrollHeight)};o.appendChild(g),document.body.appendChild(o);let y=document.createElement("script");y.src=this.bootJS.src,y.integrity=this.bootJS.integrity,y.crossOrigin="anonymous",document.body.appendChild(y);const v=e=>e.returnValue="downloading",w=this.downloadZip.bind(this);r.onclick=function(){r.disabled=!0,window.addEventListener("beforeunload",v),w(JSON.parse(s.value),c,b,f).then((()=>window.removeEventListener("beforeunload",v))).catch((e=>{b("エラー出た"),"string"==typeof e.message&&(b(e.message),console.error(e.message)),console.error(e),window.removeEventListener("beforeunload",v)}))}}async downloadZip(e,t,o,n){if(!this.isDownloadJsonObj(e))throw new Error("ダウンロード対象オブジェクトの型が不正");await this.script("https://cdn.jsdelivr.net/npm/web-streams-polyfill@2.0.2/dist/ponyfill.min.js"),await this.script("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/StreamSaver.js"),await this.script("https://cdn.jsdelivr.net/npm/streamsaver@2.0.3/examples/zip-stream.js");const s=this,i=this.utils,r=i.encodeFileName(e.id),a=streamSaver.createWriteStream(`${r}.zip`),l=new createWriter({async pull(a){const l=Math.floor(Date.now()/1e3);let c=0;const d=(e,t)=>a.enqueue(new File(e,`${r}/${t}`));o(`@${e.id} 投稿:${e.postCount} ファイル:${e.fileCount}`),d([s.createHtmlFromBody(e.id,s.createRootHtmlFromPosts(e.posts))],"index.html");let p=0;for(const r of e.posts){if(o(`${r.originalName} (${++p}/${e.postCount})`),d([r.informationText],`${r.encodedName}/info.txt`),d([s.createHtmlFromBody(r.originalName,r.htmlText)],`${r.encodedName}/index.html`),r.cover){o(`download ${r.cover.name}`);const e=await s.download(r.cover,1);e&&d([e],`${r.encodedName}/${r.cover.name}`)}let a=0;for(const p of r.files){o(`download ${p.encodedName} (${++a}/${r.files.length})`);const u=await s.download({url:p.url,name:p.encodedName},1);u?d([u],`${r.encodedName}/${p.encodedName}`):(console.error(`${p.encodedName}(${p.url})のダウンロードに失敗、読み飛ばすよ`),o(`${p.encodedName}のダウンロードに失敗`)),c++,setTimeout((()=>{const o=Math.floor(Math.abs(Math.floor(Date.now()/1e3)-l)*(e.fileCount-c)/c),s=o/3600|0;n(`${s}:${("00"+((o-3600*s)/60|0)).slice(-2)}`),t(100*c/e.fileCount|0)}),0),await i.sleep(100)}}a.close()}});if(window.WritableStream&&l.pipeTo)return l.pipeTo(a).then((()=>console.log("done writing")));const c=a.getWriter(),d=l.getReader(),p=()=>d.read().then((e=>e.done?c.close():c.write(e.value).then(p)));await p()}async script(e){return new Promise(((t,o)=>{let n=document.createElement("script");n.src=e,n.onload=()=>t(n),n.onerror=e=>o(e),document.head.appendChild(n)}))}async download({url:e,name:t},o){if(o<0)return null;try{return await fetch(e).catch((e=>{throw new Error(e)})).then((e=>e.ok?e.blob():null))||await this.download({url:e,name:t},o-1)}catch(n){return console.error(`通信エラー: ${t}, ${e}`),await this.utils.sleep(1e3),await this.download({url:e,name:t},o-1)}}isDownloadJsonObj(e){switch(!0){case"object"!=typeof e:return console.error("ダウンロード用オブジェクトの型が不正(対象がobjectでない)",e),!1;case"number"!=typeof e.postCount:return console.error("ダウンロード用オブジェクトの型が不正(postCountが数値でない)",e.postCount),!1;case"number"!=typeof e.fileCount:return console.error("ダウンロード用オブジェクトの型が不正(fileCountが数値でない)",e.fileCount),!1;case"string"!=typeof e.id:return console.error("ダウンロード用オブジェクトの型が不正(idが文字列でない)",e.id),!1;case!Array.isArray(e.posts):return console.error("ダウンロード用オブジェクトの型が不正(postsが配列でない)",e.posts),!1}return!e.posts.some((t=>{switch(!0){case"object"!=typeof t:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にobjectでないものが含まれる)",t,e.posts),!0;case"string"!=typeof t.informationText:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にinformationTextが文字列でないものが含まれる)",t.informationText,e.posts),!0;case"string"!=typeof t.htmlText:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にhtmlTextが文字列でないものが含まれる)",t.htmlText,e.posts),!0;case!Array.isArray(t.files):return console.error("ダウンロード用オブジェクトの型が不正(postsの値にfilesが配列でないものが含まれる)",t.files,e.posts),!0;case t.files.some((o=>{var n,s,i,r;switch(!0){case"object"!=typeof o:return console.error("ダウンロード用オブジェクトの型が不正(postsのfilesの値にオブジェクトでないものが含まれる)",o,t.files),!0;case"string"!=typeof o.url:return console.error("ダウンロード用オブジェクトの型が不正(postsのfilesの値にurlが文字列でないものが含まれる)",o.url,t.files),!0;case"string"!=typeof o.originalName:return console.error("ダウンロード用オブジェクトの型が不正(postsのfilesの値にoriginalNameが文字列でないものが含まれる)",o.originalName,t.files),!0;case"string"!=typeof o.encodedName:return console.error("ダウンロード用オブジェクトの型が不正(postsのfilesの値にencodedNameが文字列でないものが含まれる)",o.encodedName,t.files),!0;case void 0===t.cover:return!1;case"object"!=typeof t.cover:return console.error("ダウンロード用オブジェクトの型が不正(postsの値にcoverがobjectでないものが含まれる)",t.cover,e.posts),!0;case"string"!=typeof(null===(n=t.cover)||void 0===n?void 0:n.url):return console.error("ダウンロード用オブジェクトの型が不正(postsのcoverの値にurlが文字列でないものが含まれる)",null===(s=t.cover)||void 0===s?void 0:s.url,t.cover),!0;case"string"!=typeof(null===(i=t.cover)||void 0===i?void 0:i.name):return console.error("ダウンロード用オブジェクトの型が不正(postsのcoverの値にnameが文字列でないものが含まれる)",null===(r=t.cover)||void 0===r?void 0:r.name,t.cover),!0;default:return!1}})):return!0;default:return!1}}))}createRootHtmlFromPosts(e){return e.map((e=>`<a class="hl" href="./${this.utils.encodeURI(e.encodedName)}/index.html"><div class="root card">\n`+this.createCoverHtmlFromPost(e)+`<div class="card-body"><h5 class="card-title">${e.originalName}</h5></div>\n</div></a><br>\n`)).join("\n")}createCoverHtmlFromPost(e){const t=`./${this.utils.encodeURI(e.encodedName)}/`;if(e.cover)return`<img class="card-img-top gray-card" src="${t}${this.utils.encodeURI(e.cover.name)}" alt="カバー画像"/>\n`;const o=e.files.filter((e=>this.utils.isImage(e.encodedName)));return o.length>0?'<div class="carousel slide" data-bs-ride="carousel" data-interval="1000"><div class="carousel-inner">\n<div class="carousel-item active">'+o.map((e=>`<div class="d-flex justify-content-center gray-carousel"><img src="${t}${this.utils.encodeURI(e.encodedName)}" class="d-block pd-carousel" height="180px"/></div>`)).join('</div>\n<div class="carousel-item">')+"</div>\n</div></div>\n":'<img class="card-img-top gray-card"/>\n'}createHtmlFromBody(e,t){return`<!DOCTYPE html>\n<html lang="ja">\n<head>\n<meta charset="utf-8" />\n<title>${e}</title>\n<link href="${this.bootCSS.href}" rel="stylesheet" integrity="${this.bootCSS.integrity}" crossOrigin="anonymous">\n<style>div.main{width: 600px; float: none; margin: 0 auto}div.root{width: 400px}div.post{width: 600px}a.hl,a.hl:hover{color: inherit;text-decoration: none;}div.card{float: none; margin: 0 auto;}img.gray-card{height: 210px;background-color: gray;}div.gray-carousel{height: 210px; width: 400px;background-color: gray;}img.pd-carousel{height: 210px; padding: 15px;}</style>\n</head>\n<body>\n<div class="main">\n${t}\n</div>\n<script src="${this.bootJS.src}" integrity="${this.bootJS.integrity}" crossOrigin="anonymous"><\/script>\n</body></html>`}}let r=0,a=!1;const l=new class{constructor(){this.coverExt=/\.(apng|avif|gif|jpg|jpeg|jfif|pjpeg|pjp|png|svg|webp)$/}encodeFileName(e){return e.replace(/\//g,"／").replace(/\\/g,"＼").replace(/,/g,"，").replace(/:/g,"：").replace(/\*/g,"＊").replace(/"/g,"“").replace(/</g,"＜").replace(/>/g,"＞").replace(/\|/g,"｜").trimEnd()}encodeURI(e){return this.encodeFileName(e).replaceAll(/[;,/?:@&=+$#]/g,encodeURIComponent)}splitExt(e){return e.split(/(?=\.[^.]+$)/)}getFileName(e,t,o,n){return o<=1?`${e}${t}`:`${e}_${n}${t}`}isImage(e){return null!=e.match(this.coverExt)}async sleep(e){return new Promise((t=>setTimeout(t,e)))}};async function c(){var e,t,o,n;let s=null;if("https://downloads.fanbox.cc"===window.location.origin)return void await new i(l).createDownloadUI("fanbox-downloader");if("https://www.fanbox.cc"===window.location.origin){const o=null===(e=window.location.href.match(/fanbox.cc\/@([^\/]*)/))||void 0===e?void 0:e[1],n=null===(t=window.location.href.match(/fanbox.cc\/@.*\/posts\/(\d*)/))||void 0===t?void 0:t[1];s=await d(o,n)}else{if(!window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//))return void alert(`ここどこですか(${window.location.href})`);{const e=null===(o=window.location.href.match(/^https:\/\/(.*)\.fanbox\.cc\//))||void 0===o?void 0:o[1],t=null===(n=window.location.href.match(/.*\.fanbox\.cc\/posts\/(\d*)/))||void 0===n?void 0:n[1];s=await d(e,t)}}if(!s)return;const r=s.stringify();console.log(r),await navigator.clipboard.writeText(r),alert("jsonをコピーしました。downloads.fanbox.ccで実行して貼り付けてね"),confirm("downloads.fanbox.ccに遷移する？")&&(document.location.href="https://downloads.fanbox.cc")}async function d(e,t){if(!e)return alert("しらないURL"),null;const n=new o(e,l);return t?h(n,m(t)):await async function(e,t){a=confirm("無料コンテンツを省く？");const o=prompt("取得制限数を入力 キャンセルで全て取得");r=o?Number.parseInt(o):null;let n=1,s=`https://api.fanbox.cc/post.listCreator?creatorId=${t}&limit=100`;for(;null!=s;n++)console.log(n+"回目"),s=p(e,s,!0),await l.sleep(100)}(n,e),n}function p(e,t,o){const n=JSON.parse(u(t)),s=n.body.items;console.log("投稿の数:"+s.length);for(let t=0;t<s.length&&0!==r;t++)o?(console.log(s[t]),h(e,s[t])):h(e,m(s[t].id));return n.body.nextUrl}function u(e){const t=new XMLHttpRequest;return t.open("GET",e,!1),t.withCredentials=!0,t.send(null),t.responseText}function m(e){return JSON.parse(u(`https://api.fanbox.cc/post.info?postId=${e}`)).body}function h(e,t){if(!t||a&&0===t.feeRequired)return;if(!t.body)return void console.log(`取得できませんでした(支援がたりない？)\nfeeRequired: ${t.feeRequired}@${t.id}`);const o=t.title,n=e.addPost(o),s=(e=>{var t;if(e){const s=null!==(t=e.split(".").pop())&&void 0!==t?t:"";return`${n.getImageLinkTag(n.setCover("cover",s,e))}<h5>${o}</h5>\n`}return`<h5>${o}</h5>\n<br>\n`})(t.coverImageUrl),i=`id: ${t.id}\ntitle: ${t.title}\nfee: ${t.feeRequired}\npublishedDatetime: ${t.publishedDatetime}\nupdatedDatetime: ${t.updatedDatetime}\ntags: ${t.tags.join(", ")}\nexcerpt:\n${t.excerpt}\ntxt:\n`;let c;switch(t.type){case"image":{const e=t.body.images.map((e=>n.addFile(o,e.extension,e.originalUrl))).map((e=>n.getImageLinkTag(e))).join("<br>\n"),i=t.body.text.split("\n").map((e=>`<span>${e}</span>`)).join("<br>\n");n.setHtml(s+e+"<br>\n"+i),c=`${t.body.text}\n`;break}case"file":{const e=t.body.files.map((e=>n.addFile(e.name,e.extension,e.url))).map((e=>l.isImage(e.getEncodedExtension())?n.getImageLinkTag(e):n.getFileLinkTag(e))).join("<br>\n"),o=t.body.text.split("\n").map((e=>`<span>${e}</span>`)).join("<br>\n");n.setHtml(s+e+"<br>\n"+o),c="file type text is not implemented\n";break}case"article":{const e=function(e,t){const o=t.filter((e=>"image"===e.type)).map((e=>e.imageId)),n=e=>{var t;return null!==(t=o.indexOf(e))&&void 0!==t?t:o.length};return Object.keys(e).sort(((e,t)=>n(e)-n(t))).map((t=>e[t]))}(t.body.imageMap,t.body.blocks).map((e=>n.addFile(o,e.extension,e.originalUrl))),i=function(e,t){const o=t.filter((e=>"file"===e.type)).map((e=>e.fileId)),n=e=>{var t;return null!==(t=o.indexOf(e))&&void 0!==t?t:o.length};return Object.keys(e).sort(((e,t)=>n(e)-n(t))).map((t=>e[t]))}(t.body.fileMap,t.body.blocks).map((e=>n.addFile(e.name,e.extension,e.url))),r=function(e,t){const o=t.filter((e=>"embed"===e.type)).map((e=>e.embedId)),n=e=>{var t;return null!==(t=o.indexOf(e))&&void 0!==t?t:o.length};return Object.keys(e).sort(((e,t)=>n(e)-n(t))).map((t=>e[t]))}(t.body.embedMap,t.body.blocks);let a=0,d=0,p=0;const u=t.body.blocks.map((t=>{switch(t.type){case"p":return`<span>${t.text}</span>`;case"header":return`<h2><span>${t.text}</span></h2>`;case"file":const o=i[d++];return l.isImage(o.getEncodedExtension())?n.getImageLinkTag(o):n.getFileLinkTag(o);case"image":return n.getImageLinkTag(e[a++]);case"embed":return`<span>${r[p++]}</span>`;default:return console.error(`unknown block type: ${t.type}`)}})).join("<br>\n");n.setHtml(s+u),c=t.body.blocks.filter((e=>"p"===e.type||"header"===e.type)).map((e=>e.text)).join("\n")+"\n";break}case"text":{let e="";t.body.text?(e=t.body.text.split("\n").map((e=>`<span>${e}</span>`)).join("<br>\n"),c=t.body.text):t.body.blocks?(e=t.body.blocks.map((e=>{switch(e.type){case"header":return`<h2><span>${e.text}</span></h2>`;case"p":return`<span>${e.text}</span>`;default:return""}})).join("<br>\n"),c=t.body.blocks.map((e=>"header"==e.type||"p"==e.type?e.text:"")).join("\n")+"\n"):c="undefined text type\n",n.setHtml(s+e);break}default:c=`不明なタイプ\n${t.type}@${t.id}\n`,console.log(`不明なタイプ\n${t.type}@${t.id}`)}n.setInfo(i+c),null!=r&&r--}var f=t.D;export{f as main};